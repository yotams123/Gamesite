{% extends "base.html" %}

{% block title %} Pong {% endblock %}

{% block head_content %}
    <style>
        canvas{
            border: 1px solid red;
            position: absolute;
            left: 30%;
            background-color: #3cb371;
        }

        body{
            background-color: #574B49;
        }

        h1{
            font-family: "courier new";
            color: red;
            text-align: center;
            width: 27%;
        }

        h3{
            float: left;
            position: absolute;
            left: 3%;
            color: red;
            font-family: "courier new";
            font-weight: bold;
        }

    </style>
{% endblock %}

{% block body_content %}
    <h1><strong>Pong</strong></h1>
    <h3 class="scoreDisplay">Your Current Score: 0</h3>
    <canvas id="canvas">
    </canvas>
    <script>

        let interval;

        let startGame = (() => {
            let canvas = document.getElementById("canvas");
            canvas.width = 0.6 * window.innerWidth;
            canvas.height =  0.7 * window.innerHeight;
            let drawer = canvas.getContext("2d");
            let canvasWidth = parseInt(getComputedStyle(canvas).width);
            let canvasHeight = parseInt(getComputedStyle(canvas).height);
            let rectColor = "#00d9f0";
            drawer.fillStyle = rectColor;

            let wallPadding = 5;
            let paddleWidth = canvasWidth/80;

            let paddleLength = canvasHeight/4;
            let paddleX = canvasWidth - paddleWidth - wallPadding;
            let startY = canvasHeight/2 - paddleLength/2;

            let ball = new Ball(canvasWidth, canvasHeight, drawer);
            let wall = new Paddle(5, 0, paddleWidth, canvasHeight, canvasHeight, canvasWidth, drawer, rectColor);
            let paddle = new Paddle(paddleX, startY, paddleWidth, paddleLength, canvasHeight, canvasWidth, drawer, rectColor, ball, wall);

            interval = setInterval(paddle.runGame, 20);

            document.addEventListener("keydown", paddle.changeDirection);
        })();

        function Ball(canvasWidth, canvasHeight, drawer) {
            this.color = "#94002b"
            this.drawer = drawer;

            this.speedX = 3;
            this.speedY = 0;
            this.ballWidth = 0.02 * canvasWidth;
            this.ballHeight = 0.05*canvasHeight;
            this.canvasHeight = canvasHeight;

            this.posX = (canvasWidth - this.ballWidth)/2;
            this.posY = (canvasHeight - this.ballHeight)/2;

            this.move = () =>
            {
                if (Math.floor(this.posY) < -this.speedY || Math.ceil(this.posY) == Math.ceil(this.canvasHeight - this.ballHeight)){
                    this.speedY *= -1;
                }
                this.drawer.clearRect(this.posX - 1, this.posY - 1, this.ballWidth + 2, this.ballHeight + 2);
                this.posX += this.speedX;
                this.posY += this.speedY;
                this.redraw();
            }

            this.collision = paddle =>
            {
                this.speedX > 0? this.speedX = -1*(this.speedX +1) : this.speedX = -1*(this.speedX - 1);
                this.speedY += 0.2 * paddle.speed;
            }

            this.redraw = () => {
                this.drawer.fillStyle = this.color;
                this.drawer.fillRect(this.posX, this.posY, this.ballWidth, this.ballHeight);
            }
        }

        function Paddle(paddleX, startY, paddleWidth, paddleLength, canvasHeight, canvasWidth, drawer, rectColor, ball, wall="_"){
            this.drawer = drawer;
            this.drawer.fillRect(paddleX, startY, paddleWidth, paddleLength);

            this.positionY = startY;
            this.paddleLength = paddleLength;
            this.paddleX = paddleX;
            this.paddleWidth = paddleWidth;
            this.wall = wall;

            this.speed = 0;
            this.canvasHeight = canvasHeight;
            this.canvasWidth = canvasWidth;

            this.ball = ball;

            this.changeDirection = e => {
                keyId = e.charCode? e.charCode: e.which? e.which: e.keycode;
                if (keyId == 38){   // up
                    this.speed = -5;

                    this.positionY> -1 * this.speed? this.positionY += parseInt(this.speed): this.positionY=0;
                } else if (keyId == 40){   // down
                    this.speed = 5;
                }
            }

            this.move = () => {
                this.drawer.clearRect(this.paddleX - 5, this.positionY - 5, this.paddleWidth + 10, this.paddleLength + 10);
                if (this.speed < 0 && this.positionY > -this.speed){
                    this.positionY += this.speed;
                } else if (this.speed > 0 && this.positionY + this.paddleLength + this.speed < this.canvasHeight){
                    this.positionY += this.speed;
                } else if (this.speed < 0){
                    this.positionY = 0;
                } else if (this.speed > 0){
                    this.positionY = this.canvasHeight - this.paddleLength;
                }
            }

            this.draw = () => {
                this.drawer.fillRect(this.paddleX, this.positionY, this.paddleWidth, this.paddleLength);
            }

            this.runGame = () =>
            {
                this.move();
                this.draw();
                this.wall.draw();

                this.ball.move();
                this.drawer.fillStyle = rectColor;

                if (Math.floor(this.ball.posX + this.ball.ballWidth) > Math.floor(this.paddleX) && this.ball.posY + this.ball.ballHeight > this.positionY && this.positionY + this.paddleLength > this.ball.posY ){  // any part of the ball hits any part of the paddle
                    this.ball.collision(this);
                }
                if (Math.floor(this.ball.posX) <= Math.floor(this.wall.paddleX + this.wall.paddleWidth)){
                    this.ball.collision(this.wall);
                }

                if (this.ball.posX >= this.canvasWidth){
                    clearInterval(interval);
                    alert("Game over!");
                }
            }
        }

    </script>
{% endblock %}

